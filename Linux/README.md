# Intune Linux Custom Compliance scripts 3.0
Example scripts how to run Linux Custom Compliance checks with Intune.
This script is Bash script which includes Powershell script inside.

![Intune_Linux_CustomComplianceCheck_RebootRequired_Compliant_small.png](https://github.com/petripaavola/Intune/blob/master/Linux/pics/Intune_Linux_CustomComplianceCheck_RebootRequired_Compliant_small.png)

## Quick links to files:
* [Intune_Linux_Custom_Compliance_script.sh](https://github.com/petripaavola/Intune/blob/master/Linux/Intune_Linux_Custom_Compliance_script.sh)
* [Intune_Linux_Custom_Compliance_script_Rules_file.json](https://github.com/petripaavola/Intune/blob/master/Linux/Intune_Linux_Custom_Compliance_script_Rules_file.json)

## Compliance checks in this script
*	Powershell is installed
*	Reboot Required check (file should not exist /var/run/reboot-required)
* MS Edge
  * Check MS Edge is installed (file should exist /opt/microsoft/msedge/msedge
  *	Check MS Edge version
*	Powershell version (7.3.3 minimum currently configured in json)
* Kernel version
  *	Check Kernel version (5.19.35-generic minimum currently configured in json)
  *	Check Kernel patch level
  *	Check Kernel flavour
  *	Check Kernel tainted state
*	SecureBoot status (require SecureBoot configured in json)
* sysctrl values (placeholder to check any value)
  *	user.max_user_namespaces
*	gsettings values  (placeholder to check any value)
  *	org.gnome.desktop.screensaver lock-enabled
  * org.gnome.desktop.screensaver idle-activation-enabled
  * org.gnome.desktop.session idle-delay (10 minutes currently configured in json)
*	Defender for Endpoint on Linux status
  * MicrosoftDefenderForEndpointOnLinux_Installed
  * MicrosoftDefenderForEndpointOnLinux_RegisteredToOrganization
  * MicrosoftDefenderForEndpointOnLinux_Healthy
  * MicrosoftDefenderForEndpointOnLinux_DefinitionsStatus_up_to_date
  * MicrosoftDefenderForEndpointOnLinux_real_time_protection_enabled

## How script works
Linux Compliance script itself is Bash script because POSIX-compliant shell script is requirement for Intune. However script includes Powershell script and compliance checks are done in Powershell part.

So Bash script is just launcher for Powershell script

Script creates 2 log files for debugging and testing
* /tmp/IntuneCustomComplianceScript_Bash.log
* /tmp/IntuneCustomComplianceScript_Powershell.log

Script is run in user context who enrolled Ubuntu device to Intune. You can verify this from log files.

Be sure NOT to write anything to STDOUT because that will break the compliance check. Only Powershell part of script is allowed to return compressed JSON to STDOUT which is then passed to Intune for custom Compliance Check.

## Requirements
* Powershell must be installed for this script to work
  * Script will check existence of Powershell (/opt/microsoft/powershell/7/pwsh)
  * Check these [Microsoft instructions](https://learn.microsoft.com/en-us/powershell/scripting/install/install-ubuntu?view=powershell-7.2) how to install Powershell to Ubuntu
* You can create Dynamic Azure AD Group for targeting the Linux Compliance Policy using this rule
  * **(device.deviceOSType -eq "Linux")**

## Limits
* Check current limits from [Microsoft documentation](https://learn.microsoft.com/en-us/mem/intune/protect/compliance-custom-script#limits)
* Scripts can be no larger than 1 megabyte (MB) each.
* Output generated by each script can be no larger than 1 MB.
* Scripts must have a limited run time:
  * **On Linux, scripts must take five minutes or less to run.**
  * On Windows, scripts must take 10 minutes or less to run.
* Own personal note: script is run in user context who enrolled device to Intune. This might limit being creative and thinking outside the box :)

## Screenshots
![Intune_Linux_CustomComplianceCheck_RebootRequired_Compliant.png](https://github.com/petripaavola/Intune/blob/master/Linux/pics/Intune_Linux_CustomComplianceCheck_RebootRequired_Compliant.png)
![Intune_Linux_CustomComplianceCheck_RebootRequired_NotCompliant.png](https://github.com/petripaavola/Intune/blob/master/Linux/pics/Intune_Linux_CustomComplianceCheck_RebootRequired_NotCompliant.png)

**Intune Linux Compliance Policy**

![Intune_Linux_Compliance_Policy.png](https://github.com/petripaavola/Intune/blob/master/Linux/pics/Intune_Linux_Compliance_Policy.png)
